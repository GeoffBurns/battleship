<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Master / Detail JSON Manager (localStorage)</title>
    <style>
      :root {
        --bg: #0f1724;
        --panel: #0b1220;
        --muted: #94a3b8;
        --accent: #60a5fa;
        --danger: #fb7185;
        --glass: rgba(255, 255, 255, 0.03);
      }
      * {
        box-sizing: border-box;
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI',
          Roboto, 'Helvetica Neue', Arial;
      }
      html,
      body,
      #app {
        height: 100%;
        margin: 0;
        background: linear-gradient(180deg, var(--bg), #071022);
        color: #e6eef8;
      }
      #app {
        display: flex;
        gap: 16px;
        padding: 18px;
      }

      .panel {
        background: linear-gradient(180deg, var(--panel), #071226);
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 6px 20px rgba(2, 6, 23, 0.6);
        flex: 1;
        min-height: 120px;
      }
      .left {
        width: 360px;
        max-width: 40%;
        display: flex;
        flex-direction: column;
      }
      .right {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
      }
      button {
        background: var(--glass);
        border: 1px solid rgba(255, 255, 255, 0.04);
        color: inherit;
        padding: 8px 10px;
        border-radius: 8px;
        cursor: pointer;
      }
      button:hover {
        filter: brightness(1.08);
      }
      .danger {
        background: rgba(255, 0, 0, 0.06);
        border-color: rgba(255, 0, 0, 0.12);
      }
      input[type='search'],
      input[type='text'] {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.04);
        padding: 8px;
        border-radius: 8px;
        color: inherit;
        width: 100%;
      }

      .list {
        overflow: auto;
        border-radius: 8px;
        padding: 6px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .item {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.03);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }
      .item .meta {
        display: flex;
        flex-direction: column;
      }
      .item .title {
        font-weight: 600;
      }
      .item .small {
        font-size: 12px;
        color: var(--muted);
      }
      .item.selected {
        outline: 2px solid rgba(96, 165, 250, 0.18);
        background: linear-gradient(
          90deg,
          rgba(96, 165, 250, 0.03),
          transparent
        );
      }

      .editor {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      label {
        font-size: 13px;
        color: var(--muted);
      }
      input[type='text'].full {
        width: 100%;
      }
      textarea {
        width: 100%;
        min-height: 240px;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.04);
        padding: 10px;
        border-radius: 8px;
        color: inherit;
        font-family: monospace;
      }
      .row {
        display: flex;
        gap: 8px;
      }
      .row > * {
        flex: 1;
      }
      footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
      }
      .muted {
        color: var(--muted);
      }
      .hint {
        font-size: 12px;
        color: var(--muted);
      }
      .small-btn {
        padding: 6px 8px;
        font-size: 13px;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      .tag {
        background: rgba(255, 255, 255, 0.03);
        padding: 4px 6px;
        border-radius: 6px;
        font-size: 12px;
      }

      @media (max-width: 800px) {
        #app {
          flex-direction: column;
        }
        .left {
          width: auto;
          max-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="panel left">
        <div class="topbar">
          <div style="display: flex; flex-direction: column">
            <strong>Items</strong>
            <span class="hint"
              >Master list stored in <code>localStorage</code></span
            >
          </div>
          <div style="display: flex; gap: 8px; align-items: center">
            <button id="btnNew">+ New</button>
            <button id="btnClone" title="Clone selected" class="small-btn">
              Clone
            </button>
          </div>
        </div>

        <div class="toolbar">
          <input
            id="search"
            type="search"
            placeholder="Search titles or tags..."
          />
          <select id="sort" title="Sort">
            <option value="updated">Sort: updated</option>
            <option value="created">Sort: created</option>
            <option value="title">Sort: title</option>
          </select>
        </div>

        <div id="list" class="list" aria-live="polite"></div>

        <div style="display: flex; gap: 8px; margin-top: 8px">
          <button id="btnExportAll">Export all</button>
          <button id="btnImport">Import</button>
          <button id="btnClear" class="danger">Clear</button>
          <input
            id="fileInput"
            type="file"
            accept="application/json"
            style="display: none"
          />
        </div>
      </div>

      <div class="panel right">
        <div class="topbar">
          <div>
            <strong>Detail</strong>
            <div class="hint" id="detailHint">
              Select or create an item to edit
            </div>
          </div>
          <div style="display: flex; gap: 8px">
            <button id="btnExportSelected">Export selected</button>
            <button id="btnDelete" class="danger">Delete</button>
          </div>
        </div>

        <div class="editor">
          <label>Title</label>
          <input id="title" class="full" type="text" placeholder="Item title" />

          <div class="row">
            <div>
              <label>Tags (comma separated)</label>
              <input id="tags" type="text" placeholder="tag1, tag2" />
            </div>
            <div>
              <label>ID</label>
              <input id="id" type="text" readonly />
            </div>
          </div>

          <label>JSON Payload</label>
          <textarea id="payload" placeholder='{"foo": "bar"}'></textarea>

          <footer>
            <div class="muted">Last saved: <span id="savedAt">—</span></div>
            <div style="display: flex; gap: 8px">
              <button id="btnSave">Save</button>
              <button id="btnPretty" class="small-btn">Format JSON</button>
            </div>
          </footer>
        </div>
      </div>
    </div>

    <script>
      ;(() => {
        // storage key
        const KEY = 'md_json_items_v1'
        const appState = { items: [], selectedId: null }

        // --- DOM helpers ---
        const $ = id => document.getElementById(id)
        const listEl = $('list')
        const titleEl = $('title')
        const tagsEl = $('tags')
        const idEl = $('id')
        const payloadEl = $('payload')
        const savedAtEl = $('savedAt')
        const btnNew = $('btnNew')
        const btnSave = $('btnSave')
        const btnDelete = $('btnDelete')
        const btnClone = $('btnClone')
        const btnExportAll = $('btnExportAll')
        const btnImport = $('btnImport')
        const fileInput = $('fileInput')
        const btnExportSelected = $('btnExportSelected')
        const btnClear = $('btnClear')
        const searchEl = $('search')
        const sortEl = $('sort')
        const btnPretty = $('btnPretty')
        const detailHint = $('detailHint')

        // utilities
        const now = () => new Date().toISOString()
        const uid = () => 'id_' + Math.random().toString(36).slice(2, 9)
        const deepClone = v => JSON.parse(JSON.stringify(v))

        // --- storage ---
        function loadFromLocal() {
          try {
            const raw = localStorage.getItem(KEY)
            appState.items = raw ? JSON.parse(raw) : []
          } catch (e) {
            console.error('load failed', e)
            appState.items = []
          }
        }
        function saveToLocal() {
          try {
            localStorage.setItem(KEY, JSON.stringify(appState.items))
          } catch (e) {
            console.error('save failed', e)
            alert('Failed to save to localStorage: ' + e.message)
          }
        }

        // --- UI rendering ---
        function renderList() {
          const q = ((searchEl && searchEl.value) || '').trim().toLowerCase()
          let items = [...appState.items]
          const sort = (sortEl && sortEl.value) || 'updated'

          items.sort((a, b) => {
            if (sort === 'title')
              return (a.title || '').localeCompare(b.title || '')
            if (sort === 'created')
              return (a.createdAt || '').localeCompare(b.createdAt || '')
            return (b.updatedAt || '').localeCompare(a.updatedAt || '')
          })

          listEl.innerHTML = ''

          items
            .filter(it => {
              if (!q) return true
              const hay = (
                (it.title || '') +
                ' ' +
                (it.tags || []).join(' ') +
                ' ' +
                JSON.stringify(it.payload || {})
              ).toLowerCase()
              return hay.includes(q)
            })
            .forEach(it => {
              const div = document.createElement('div')
              div.className =
                'item' + (it.id === appState.selectedId ? ' selected' : '')

              // left metadata
              const left = document.createElement('div')
              left.className = 'meta'
              const t = document.createElement('div')
              t.className = 'title'
              t.textContent = it.title || '(untitled)'

              const s = document.createElement('div')
              s.className = 'small'
              const tagSpan = document.createElement('span')
              tagSpan.className = 'tag'
              tagSpan.textContent = (it.tags || []).slice(0, 3).join(', ')
              s.appendChild(tagSpan)
              s.appendChild(
                document.createTextNode(
                  ' • ' +
                    new Date(
                      it.updatedAt || it.createdAt || now()
                    ).toLocaleString()
                )
              )

              left.appendChild(t)
              left.appendChild(s)

              // right actions
              const right = document.createElement('div')
              const btn = document.createElement('button')
              btn.textContent = 'Open'
              btn.type = 'button'
              btn.addEventListener('click', e => {
                e.stopPropagation()
                selectItem(it.id)
              })

              div.appendChild(left)
              div.appendChild(right)
              right.appendChild(btn)
              div.addEventListener('click', () => selectItem(it.id))
              listEl.appendChild(div)
            })
        }

        function selectItem(id) {
          const it = appState.items.find(x => x.id === id)
          if (!it) return
          appState.selectedId = id
          // populate detail
          titleEl.value = it.title || ''
          tagsEl.value = (it.tags || []).join(', ')
          idEl.value = it.id
          payloadEl.value = JSON.stringify(it.payload || {}, null, 2)
          savedAtEl.textContent = new Date(
            it.updatedAt || it.createdAt || now()
          ).toLocaleString()
          detailHint.textContent = ''
          renderList()
        }

        function clearDetail() {
          appState.selectedId = null
          renderList()
          titleEl.value = ''
          tagsEl.value = ''
          idEl.value = ''
          payloadEl.value = ''
          savedAtEl.textContent = '—'
          detailHint.textContent = 'Select or create an item to edit'
        }

        function createNew() {
          const it = {
            id: uid(),
            title: 'New item',
            tags: [],
            payload: {},
            createdAt: now(),
            updatedAt: now()
          }
          appState.items.unshift(it)
          saveToLocal()
          selectItem(it.id)
        }

        function saveSelected() {
          if (!appState.selectedId) {
            alert('No item selected')
            return
          }
          const it = appState.items.find(x => x.id === appState.selectedId)
          if (!it) return

          let payload = null
          try {
            payload = payloadEl.value.trim() ? JSON.parse(payloadEl.value) : {}
          } catch (e) {
            alert('JSON parse error in payload: ' + e.message)
            return
          }

          it.title = titleEl.value.trim() || '(untitled)'
          it.tags = tagsEl.value
            .split(',')
            .map(s => s.trim())
            .filter(Boolean)
          it.payload = payload
          it.updatedAt = now()

          saveToLocal()
          savedAtEl.textContent = new Date(it.updatedAt).toLocaleString()
          renderList()
        }

        function deleteSelected() {
          if (!appState.selectedId) {
            alert('No item selected')
            return
          }
          if (!confirm('Delete the selected item? This cannot be undone.'))
            return
          appState.items = appState.items.filter(
            x => x.id !== appState.selectedId
          )
          saveToLocal()
          clearDetail()
          renderList()
        }

        function cloneSelected() {
          if (!appState.selectedId) {
            alert('No item selected')
            return
          }
          const it = appState.items.find(x => x.id === appState.selectedId)
          if (!it) return
          const copy = deepClone(it)
          copy.id = uid()
          copy.title = (copy.title || '(untitled)') + ' (copy)'
          copy.createdAt = now()
          copy.updatedAt = now()
          appState.items.unshift(copy)
          saveToLocal()
          selectItem(copy.id)
        }

        function exportAll() {
          const blob = new Blob([JSON.stringify(appState.items, null, 2)], {
            type: 'application/json'
          })
          const a = document.createElement('a')
          a.href = URL.createObjectURL(blob)
          a.download =
            'items_' +
            new Date().toISOString().slice(0, 19).replace(/[:T]/g, '_') +
            '.json'
          document.body.appendChild(a)
          a.click()
          a.remove()
        }

        function exportSelected() {
          if (!appState.selectedId) {
            alert('No item selected')
            return
          }
          const it = appState.items.find(x => x.id === appState.selectedId)
          if (!it) return
          const titleSafe = (it.title || 'item').replace(/[^a-z0-9\-_]/gi, '_')
          const blob = new Blob([JSON.stringify(it, null, 2)], {
            type: 'application/json'
          })
          const a = document.createElement('a')
          a.href = URL.createObjectURL(blob)
          a.download = titleSafe + '.json'
          document.body.appendChild(a)
          a.click()
          a.remove()
        }

        function importFromFile(file) {
          const reader = new FileReader()
          reader.onload = e => {
            try {
              const parsed = JSON.parse(e.target.result)
              if (Array.isArray(parsed)) {
                const byId = new Map(appState.items.map(x => [x.id, x]))
                parsed.forEach(p => {
                  if (!p.id) p.id = uid()
                  if (!p.createdAt) p.createdAt = now()
                  if (!p.updatedAt) p.updatedAt = now()
                  byId.set(p.id, p)
                })
                appState.items = Array.from(byId.values())
              } else if (typeof parsed === 'object' && parsed !== null) {
                const p = parsed
                if (!p.id) p.id = uid()
                if (!p.createdAt) p.createdAt = now()
                if (!p.updatedAt) p.updatedAt = now()
                appState.items.unshift(p)
              } else {
                alert('Unsupported JSON file')
              }
              saveToLocal()
              renderList()
            } catch (err) {
              alert('Import failed: ' + err.message)
            }
          }
          reader.readAsText(file)
        }

        function clearAll() {
          if (
            !confirm(
              'Clear all items from localStorage? This cannot be undone.'
            )
          )
            return
          appState.items = []
          saveToLocal()
          clearDetail()
          renderList()
        }

        // --- event wiring ---
        btnNew.addEventListener('click', createNew)
        btnSave.addEventListener('click', saveSelected)
        btnDelete.addEventListener('click', deleteSelected)
        btnClone.addEventListener('click', cloneSelected)
        btnExportAll.addEventListener('click', exportAll)
        btnExportSelected.addEventListener('click', exportSelected)
        btnImport.addEventListener('click', () => fileInput.click())
        fileInput.addEventListener('change', e => {
          const f = e.target.files[0]
          if (!f) return
          importFromFile(f)
          fileInput.value = ''
        })
        btnClear.addEventListener('click', clearAll)
        searchEl.addEventListener('input', renderList)
        sortEl.addEventListener('change', renderList)
        btnPretty.addEventListener('click', () => {
          try {
            const obj = payloadEl.value.trim()
              ? JSON.parse(payloadEl.value)
              : {}
            payloadEl.value = JSON.stringify(obj, null, 2)
          } catch (e) {
            alert('JSON parse error: ' + e.message)
          }
        })

        // keyboard shortcuts
        document.addEventListener('keydown', e => {
          if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault()
            saveSelected()
          }
          if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
            e.preventDefault()
            createNew()
          }
        })

        // --- init & tests ---
        loadFromLocal()

        // If there were no items, seed a couple of test items so the user has something to interact with.
        // This is intended as a small 'test case' and only runs when localStorage is empty.
        if (!appState.items || appState.items.length === 0) {
          console.info('Seeding sample items into localStorage for testing.')
          appState.items = [
            {
              id: uid(),
              title: 'Sample: Todo',
              tags: ['todo', 'sample'],
              payload: { done: false, notes: 'This is a sample item.' },
              createdAt: now(),
              updatedAt: now()
            },
            {
              id: uid(),
              title: 'Sample: Config',
              tags: ['config', 'sample'],
              payload: { env: 'dev', version: 1 },
              createdAt: now(),
              updatedAt: now()
            }
          ]
          saveToLocal()
        }

        // Select first and render
        if (appState.items.length) {
          appState.selectedId = appState.items[0].id
          selectItem(appState.selectedId)
        }
        renderList()
      })()
    </script>
  </body>
</html>
